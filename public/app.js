const API_BASE_URL = 'https://ffmzs9evxj.execute-api.us-east-1.amazonaws.com/dev';
let currentData = null;

async function fetchSymbols() { try { const response = await fetch(`${API_BASE_URL}/list/symbols`); if (!response.ok) throw new Error('Error al cargar s√≠mbolos'); const result = await response.json(); return result.data || result; } catch (error) { console.error('Error:', error); return getMockSymbols(); } }

async function fetchSymbolDetail(id) { try { const response = await fetch(`${API_BASE_URL}/detail/${id}`); if (!response.ok) throw new Error('Error al cargar detalle'); const result = await response.json(); const data = result.data || result; return Array.isArray(data) ? data[0] : data; } catch (error) { console.error('Error:', error); return getMockDetail(); } }

function getMockSymbols() { return [{ "_id": "695583038e6da051ccdcf195", "instrument": { "symbol": "XAUUSD", "name": "CFDs on Gold (US$ / OZ)", "timeframe": "1h", "assetType": "Commodity" } }, { "_id": "695586e3ef9a36b6dbf20589", "instrument": { "symbol": "SILVER", "name": "CFDs on Silver", "timeframe": "1h", "assetType": "Commodity" } }, { "_id": "695586e4ef9a36b6dbf2058a", "instrument": { "symbol": "XAUUSD", "name": "CFDs on Gold (US$ / OZ)", "timeframe": "1D", "assetType": "Commodity" } }, { "_id": "695586e5ef9a36b6dbf2058b", "instrument": { "symbol": "XAGUSD", "name": "CFDs on Silver", "timeframe": "1D", "assetType": "Commodity" } }, { "_id": "6955909f69662fd6cf3c5009", "instrument": { "symbol": "BTCUSD", "name": "Bitcoin / U.S. Dollar", "timeframe": "1D", "assetType": "Cryptocurrency" } }, { "_id": "695590a269662fd6cf3c500a", "instrument": { "symbol": "XPDUSD", "name": "CFDs on Palladium", "timeframe": "1D", "assetType": "Commodity" } }, { "_id": "695590a369662fd6cf3c500b", "instrument": { "symbol": "COPPER", "name": "CFDs on Copper", "timeframe": "1D", "assetType": "Commodity" } }]; }

function getMockDetail() { return JSON.parse(document.querySelector('script[type="application/json"]').textContent); }

function renderSymbolsList(symbols) { const container = document.getElementById('symbolsList'); container.innerHTML = symbols.map(item => ` <div class="symbol-card" onclick="showDetail('${item._id}')"> <div class="symbol-header"> <div class="symbol-name">${item.instrument.symbol}</div> <div class="symbol-type">${item.instrument.assetType}</div> </div> <div class="symbol-info">${item.instrument.name}</div> <div class="symbol-timeframe">‚è± ${item.instrument.timeframe}</div> </div> `).join(''); }

function formatNumber(num, decimals = 2) { if (num === null || num === undefined) return 'N/A'; return Number(num).toLocaleString('es-CL', { minimumFractionDigits: decimals, maximumFractionDigits: decimals }); }

function formatPercent(num, decimals = 2) { if (num === null || num === undefined) return 'N/A'; return `${num >= 0 ? '+' : ''}${formatNumber(num, decimals)}%`; }

function getBadgeClass(value, type = 'trend') { if (type === 'trend') { if (value.toLowerCase().includes('alcista') || value.toLowerCase().includes('bullish')) return 'badge-success'; if (value.toLowerCase().includes('bajista') || value.toLowerCase().includes('bearish')) return 'badge-danger'; return 'badge-warning'; } if (type === 'strength') { if (value.toLowerCase().includes('fuerte') || value.toLowerCase().includes('muy')) return 'badge-danger'; if (value.toLowerCase().includes('moderado')) return 'badge-warning'; return 'badge-info'; } return 'badge-info'; }

function renderDetail(data) { currentData = data; const container = document.getElementById('detailContent');
console.log('Data recibida en renderDetail:', data);
if (!data || !data.price || !data.instrument) { container.innerHTML = '<div class="error-message">Error: Estructura de datos inv√°lida. Por favor revisa la consola.</div>'; return; }
const priceChangeClass = data.price.change >= 0 ? 'positive' : 'negative'; const priceChangeSymbol = data.price.change >= 0 ? '‚ñ≤' : '‚ñº'; container.innerHTML = ` <div class="price-header"> <div class="instrument-info"> <h1>${data.instrument.symbol}</h1> <p>${data.instrument.name} | ${data.instrument.timeframe}</p> </div> <div class="price-display"> <div class="current-price">${formatNumber(data.price.current, 3)}</div> <div class="price-change ${priceChangeClass}"> ${priceChangeSymbol} ${formatNumber(data.price.change, 2)} (${formatPercent(data.price.changePercent)}) </div> </div> </div> <div class="summary-box" style="margin-bottom: 1.5rem;"> <h3>üìã Resumen Ejecutivo</h3> <p><strong>Situaci√≥n Actual:</strong> ${data.summary.currentSituation}</p> <p><strong>Contexto Macro:</strong> ${data.summary.macroContext}</p> <p><strong>Recomendaci√≥n:</strong> ${data.summary.mainRecommendation}</p> <p><strong>Niveles Clave:</strong> ${data.summary.keyLevels}</p> </div> <div class="section trade-setup" style="margin-bottom: 1.5rem;"> <h2>üéØ Escenario Principal</h2> <div class="scenario-header"> <span class="badge badge-${data.analysis.mainScenario.direction === 'LONG' ? 'success' : 'danger'}">${data.analysis.mainScenario.direction}</span> <span class="probability">${data.analysis.mainScenario.probability}% probabilidad</span> </div> <div class="metric"> <span class="metric-label">Entrada</span> <span class="metric-value">${formatNumber(data.analysis.mainScenario.entry, 3)}</span> </div> <div class="metric"> <span class="metric-label">Stop Loss</span> <span class="metric-value">${formatNumber(data.analysis.mainScenario.stopLoss, 3)}</span> </div> <div class="targets"> <strong>Objetivos:</strong> ${data.analysis.mainScenario.targets.map(t => ` <div class="target-item"> <span>${formatNumber(t.level, 3)} - ${t.description}</span> <span class="badge badge-success">${t.rr}</span> </div> `).join('')} </div> <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);"> <strong>Razonamiento:</strong><br> <span style="color: rgba(255,255,255,0.8);">${data.analysis.mainScenario.reasoning}</span> </div> </div> ${data.analysis.alternativeScenario ? ` <div class="section" style="margin-bottom: 1.5rem;"> <h2>üîÑ Escenario Alternativo</h2> <div class="scenario-header"> <span class="badge badge-${data.analysis.alternativeScenario.direction === 'LONG' ? 'success' : 'danger'}">${data.analysis.alternativeScenario.direction}</span> <span class="probability">${data.analysis.alternativeScenario.probability}% probabilidad</span> </div> <div class="metric"> <span class="metric-label">Condici√≥n</span> <span class="metric-value">${data.analysis.alternativeScenario.condition}</span> </div> <div class="metric"> <span class="metric-label">Entrada</span> <span class="metric-value">${formatNumber(data.analysis.alternativeScenario.entry, 3)}</span> </div> <div class="metric"> <span class="metric-label">Stop Loss</span> <span class="metric-value">${formatNumber(data.analysis.alternativeScenario.stopLoss, 3)}</span> </div> <div class="targets"> <strong>Objetivos:</strong> ${data.analysis.alternativeScenario.targets.map(t => ` <div class="target-item"> <span>${formatNumber(t.level, 3)} - ${t.description}</span> <span class="badge badge-success">${t.rr}</span> </div> `).join('')} </div> </div> ` : ''} <div class="grid"> <div class="section"> <h2>üìä Tendencia Multi-Temporal</h2> <div class="metric"> <span class="metric-label">Superior</span> <span class="badge ${getBadgeClass(data.trend.multiTimeframe.superior)}">${data.trend.multiTimeframe.superior}</span> </div> <div class="metric"> <span class="metric-label">Actual</span> <span class="badge ${getBadgeClass(data.trend.multiTimeframe.actual)}">${data.trend.multiTimeframe.actual}</span> </div> <div class="metric"> <span class="metric-label">Inferior</span> <span class="badge ${getBadgeClass(data.trend.multiTimeframe.inferior)}">${data.trend.multiTimeframe.inferior}</span> </div> <div class="metric"> <span class="metric-label">Confluencia</span> <span class="metric-value">${data.trend.multiTimeframe.confluence}</span> </div> </div> <div class="section"> <h2>üìà Medias M√≥viles (EMA)</h2> <div class="metric"> <span class="metric-label">EMA 9</span> <span class="metric-value">${formatNumber(data.trend.emas.ema9.value, 3)} (${formatPercent(data.trend.emas.ema9.distance)})</span> </div> <div class="metric"> <span class="metric-label">EMA 21</span> <span class="metric-value">${formatNumber(data.trend.emas.ema21.value, 3)} (${formatPercent(data.trend.emas.ema21.distance)})</span> </div> <div class="metric"> <span class="metric-label">EMA 30</span> <span class="metric-value">${formatNumber(data.trend.emas.ema30.value, 3)} (${formatPercent(data.trend.emas.ema30.distance)})</span> </div> <div class="metric"> <span class="metric-label">EMA 50</span> <span class="metric-value">${formatNumber(data.trend.emas.ema50.value, 3)} (${formatPercent(data.trend.emas.ema50.distance)})</span> </div> <div class="metric"> <span class="metric-label">Alineaci√≥n</span> <span class="badge ${getBadgeClass(data.trend.emas.alignment)}">${data.trend.emas.alignment}</span> </div> </div> </div> <div class="grid"> <div class="section"> <h2>üî∫ Resistencias</h2> ${data.levels.resistances.map(r => ` <div class="level-item"> <div> <strong>${formatNumber(r.level, 3)}</strong> <div class="level-type">${r.type}</div> </div> <span class="badge ${getBadgeClass(r.strength, 'strength')}">${r.strength}</span> </div> `).join('')} </div> <div class="section"> <h2>üîª Soportes</h2> ${data.levels.supports.map(s => ` <div class="level-item"> <div> <strong>${formatNumber(s.level, 3)}</strong> <div class="level-type">${s.type}</div> </div> <span class="badge ${getBadgeClass(s.strength, 'strength')}">${s.strength}</span> </div> `).join('')} </div> </div> <div class="grid"> <div class="section"> <h2>üìâ Indicadores T√©cnicos</h2> <div class="metric"> <span class="metric-label">RSI</span> <span class="metric-value">${formatNumber(data.indicators.momentum.rsi)}</span> </div> <div class="metric"> <span class="metric-label">SRSI K/D</span> <span class="metric-value">${formatNumber(data.indicators.srsi.k)} / ${formatNumber(data.indicators.srsi.d)}</span> </div> <div class="metric"> <span class="metric-label">MACD</span> <span class="metric-value">${formatNumber(data.indicators.macd.histogram)}</span> </div> <div class="metric"> <span class="metric-label">ADX</span> <span class="metric-value">${formatNumber(data.indicators.momentum.adx)}</span> </div> <div class="metric"> <span class="metric-label">Fuerza Tendencia</span> <span class="badge ${getBadgeClass(data.indicators.momentum.trendStrength, 'strength')}">${data.indicators.momentum.trendStrength}</span> </div> </div> <div class="section"> <h2>üåç Correlaciones Macro</h2> <div class="metric"> <span class="metric-label">DXY</span> <span class="metric-value">${formatNumber(data.correlations.dxy.value)} <span class="badge ${getBadgeClass(data.correlations.dxy.trend)}">${data.correlations.dxy.impact}</span></span> </div> <div class="metric"> <span class="metric-label">Yields 10Y</span> <span class="metric-value">${formatNumber(data.correlations.yields10y.value)}% <span class="badge ${getBadgeClass(data.correlations.yields10y.trend)}">${data.correlations.yields10y.impact}</span></span> </div> <div class="metric"> <span class="metric-label">VIX</span> <span class="metric-value">${formatNumber(data.correlations.vix.value)} <span class="badge ${getBadgeClass(data.correlations.vix.trend)}">${data.correlations.vix.impact}</span></span> </div> <div class="metric"> <span class="metric-label">${data.correlations.other.name}</span> <span class="metric-value">${formatNumber(data.correlations.other.value, 3)} <span class="badge ${getBadgeClass(data.correlations.other.trend)}">${data.correlations.other.impact}</span></span> </div> </div> </div> <div class="section"> <h2>‚ö†Ô∏è Gesti√≥n de Riesgo</h2> <div class="metric"> <span class="metric-label">Tama√±o de Posici√≥n</span> <span class="metric-value">${data.riskManagement.positionSize}</span> </div> <div class="metric"> <span class="metric-label">Invalidaci√≥n Long</span> <span class="metric-value">${data.riskManagement.invalidationLong}</span> </div> <div class="metric"> <span class="metric-label">Invalidaci√≥n Short</span> <span class="metric-value">${data.riskManagement.invalidationShort}</span> </div> ${data.riskManagement.specialRisks.length > 0 ? ` <div style="margin-top: 1rem;"> <strong>Riesgos Especiales:</strong> <ul style="margin-left: 1.5rem; margin-top: 0.5rem; line-height: 1.8;"> ${data.riskManagement.specialRisks.map(risk => `<li>${risk}</li>`).join('')} </ul> </div> ` : ''} </div> <div class="metric" style="background: rgba(255,255,255,0.03); padding: 1rem; border-radius: 5px; margin-top: 1rem;"> <span class="metric-label">An√°lisis generado</span> <span class="metric-value">${new Date(data.metadata.analysisTimestamp).toLocaleString('es-CL')}</span> </div> `; }

async function showDetail(id) { document.getElementById('listView').style.display = 'none'; document.getElementById('detailView').style.display = 'block'; document.querySelector('.back-btn').style.display = 'block'; document.getElementById('detailContent').innerHTML = '<div class="spinner"></div>'; const data = await fetchSymbolDetail(id); renderDetail(data); window.scrollTo({ top: 0, behavior: 'smooth' }); }

function showListView() { document.getElementById('listView').style.display = 'block'; document.getElementById('detailView').style.display = 'none'; document.querySelector('.back-btn').style.display = 'none'; window.scrollTo({ top: 0, behavior: 'smooth' }); }

async function init() { const symbols = await fetchSymbols(); renderSymbolsList(symbols); if ('serviceWorker' in navigator) { try { await navigator.serviceWorker.register('sw.js'); console.log('Service Worker registrado'); } catch (error) { console.log('Error al registrar Service Worker:', error); } } }

document.addEventListener('DOMContentLoaded', init);
